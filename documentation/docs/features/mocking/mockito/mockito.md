Вот переработанная версия статьи, сделанная более простой и понятной:

---

# Мокирование в YAxUnit

[Мокито](/api/Мокито) — это модуль, созданный по образцу популярного Java-фреймворка для тестирования [Mockito](https://site.mockito.org/). Он расширяет возможности тестирования, позволяя легко изменять поведение системы, подменяя результаты работы методов, отключая алгоритмы и проверки.

## Что такое мокирование?

Мокирование — это техника, которая позволяет заменить реальное поведение методов на заранее заданное. Это полезно, когда:

- Вы хотите протестировать код, который зависит от внешних систем или сложных алгоритмов.
- Вы хотите убедиться, что методы вызываются с правильными параметрами.
- Вы хотите отключить часть логики, чтобы сосредоточиться на тестировании конкретного участка кода.

## Возможности Мокито

С помощью Мокито вы можете:

- **Изменять поведение методов**: Указывать, какие методы должны возвращать определенные значения, выбрасывать исключения или вообще не выполняться.
- **Настраивать условия**: Задавать условия для параметров методов, чтобы изменения применялись только в нужных случаях.
- **Мокировать приватные и экспортные методы**: Мокировать как публичные, так и приватные методы объектов, документов, справочников и других элементов.
- **Собирать статистику**: Наблюдать за вызовами методов, чтобы убедиться, что они вызываются с правильными параметрами.

Мокирование доступно для:

- Методов общих модулей
- Методов менеджеров
- Методов объектов (документов, справочников и т.д.)

**Примеры:**

- Мокирование метода для всех объектов определенного типа:
  ```bsl
  Мокито.Обучение(Документы.ПриходТовара)
    .Когда("ОбработкаПроведения")
  ```
- Мокирование метода для конкретного объекта:
  ```bsl
  Мокито.Обучение(ДокументОбъект)
    .Когда("ОбработкаПроведения")
  ```
- Мокирование метода для объектов с определенной ссылкой:
  ```bsl
  Мокито.Обучение(ДокументСсылка)
    .Когда("ОбработкаПроведения")
  ```

## Что Мокито не может?

- Выполнять произвольную логику при вызове метода.
- Изменять параметры методов.
- Хранить результаты вызовов при сборе статистики.

## Как работает Мокито?

Мокито работает на основе двух ключевых механизмов:

1. **Расширение методов**: Методы конфигурации заменяются на специальные обработчики, которые позволяют управлять их поведением.
2. **Глобальный контекст**: Все настройки и статистика вызовов хранятся в глобальном контексте, что позволяет управлять мокированием как из тестов, так и из замененных методов.

### Настройка мокируемых методов

Чтобы мокировать метод, его нужно добавить в расширение конфигурации. Для этого используется шаблон:

- Для функции:
  ```bsl
  &Вместо("<ИмяМетода>")
  Функция Мок_<ИмяМетода>(<ПараметрыМетода>)
    ПараметрыМетода = Мокито.МассивПараметров(<ПараметрыМетода>);
    ПрерватьВыполнение = Ложь;
    Результат = МокитоПерехват.АнализВызова(<Объект>, "<ИмяМетода>", ПараметрыМетода, ПрерватьВыполнение);
    Если Не ПрерватьВыполнение Тогда
      Возврат ПродолжитьВызов(<ПараметрыМетода>);
    Иначе
      Возврат Результат;
    КонецЕсли;
  КонецФункции
  ```

- Для процедуры:
  ```bsl
  &Вместо("<ИмяМетода>")
  Процедура Мок_<ИмяМетода>(<ПараметрыМетода>)
    ПараметрыМетода = Мокито.МассивПараметров(<ПараметрыМетода>);
    ПрерватьВыполнение = Ложь;
    МокитоПерехват.АнализВызова(<Объект>, "<ИмяМетода>", ПараметрыМетода, ПрерватьВыполнение);
    Если Не ПрерватьВыполнение Тогда
      ПродолжитьВызов(<ПараметрыМетода>);
    КонецЕсли;
  КонецПроцедуры
  ```

**Совет:** Если метод не имеет параметров, можно использовать пустой массив:
```bsl
ПараметрыМетода = Новый Массив;
```

## Этапы тестирования с Мокито

Тестирование с использованием Мокито состоит из трех этапов:

1. **Обучение**: Настройка мокирования — указываем, какие методы нужно мокировать и как они должны себя вести.
2. **Прогон**: Выполнение тестового метода с применением настроенных моков.
3. **Проверка**: Анализ вызовов методов, чтобы убедиться, что все работает как ожидается.

### Пример:

```bsl
// Подготовка
Ответ = Новый HTTPСервисОтвет(1);
Ответ.УстановитьТелоИзСтроки(СериализацияJSON.ЗначениеВСтроку(Новый Структура("id, status", "9999", "delivered")));

// Обучение мокито
Мокито.Обучение(ОтправкаСМС_Провайдер1)
  .Когда("УстановитьСоединение").Вернуть(Истина)
  .Когда("ПослатьСообщение").Вернуть(Ответ)
  .Прогон();

// Тестовый прогон
РоботОтправки.ОтправкаСМС();

// Проверка статистики
Мокито.Проверить(ОтправкаСМС_Провайдер1)
  .КоличествоВызовов("ПослатьСообщение")
  .Равно(1);
```

## Обучение мокирования

Обучение — это процесс настройки Мокито. Вы указываете, какие методы и при каких условиях должны изменить свое поведение.

### Основные методы обучения:

- **Когда()**: Указывает, какой метод и с какими параметрами нужно мокировать.
- **Вернуть()**: Настраивает метод на возврат определенного значения.
- **ВыброситьИсключение()**: Настраивает метод на выброс исключения.
- **Пропустить()**: Отключает выполнение метода.
- **Наблюдать()**: Собирает статистику по вызовам метода.

**Пример:**

```bsl
Мокито.Обучение(ОтправкаСМС_Провайдер1)
  .Когда("УстановитьСоединение").Пропустить()
  .Когда("ПослатьСообщение").Вернуть(Ответ)
  .Наблюдать("ОбработатьОтвет")
```

## Проверка вызовов

После прогона теста можно проверить, какие методы были вызваны и с какими параметрами. Для этого используется метод `Мокито.Проверить()`.

**Пример:**

```bsl
Мокито.Проверить(РаботаСHTTP)
  .КоличествоВызовов("ОтправитьОбъектНаСервер")
    .Равно(3);
```

## Примеры использования

### Пример 1: Вызов исключения при записи объекта

```bsl
Мокито.Обучение(Документы.Оплата)
  .Когда("ПередЗаписью").ВыброситьИсключение("Не удалось записать объект")
  .Прогон();

Документ = СоздатьДокументОплаты();

ЮТест.ОжидаетЧто(Документ)
  .Метод("Записать").Параметр(РежимЗаписиДокумента.Проведение)
  .ВыбрасываетИсключение("Не удалось записать объект");
```

### Пример 2: Анализ вызовов метода

```bsl
Мокито.Обучение(СуперИнтеграция)
  .Наблюдать("СоздатьОбъект")
  .Наблюдать("УдалитьОбъект")
  .Наблюдать("ОбновитьОбъект")
  .Прогон();

СуперИнтеграция.ВыполнитьСинхронизацию();

Мокито.Проверить(СуперИнтеграция)
  .КоличествоВызовов("СоздатьОбъект").Равно(1)
  .КоличествоВызовов("УдалитьОбъект").Пусто()
  .КоличествоВызовов("ОбновитьОбъект").Равно(1);
```

---

Эта переработанная версия статьи стала более структурированной и понятной, с акцентом на ключевые моменты и примеры использования.